<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <style>
    body { direction: rtl; }
    .filter-box { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9; }
    .session-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    .studio-a { color: green; font-weight: bold; }
    .studio-b { color: blue; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2 class="mb-4">ğŸ” ØµÙØ­Ø© Ø§Ù„ÙÙ„Ø§ØªØ±</h2>

    <div class="filter-box">
      <div class="row">
        <div class="col-md-4 mb-3">
          <label>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°:</label>
          <select id="teacherFilter" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>

        <div class="col-md-4 mb-3">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
          <input type="date" id="startDateFilter" class="form-control">
        </div>

        <div class="col-md-4 mb-3">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
          <input type="date" id="endDateFilter" class="form-control">
        </div>

        <div class="col-md-4 mb-3">
          <label>Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
          <select id="dayFilter" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
            <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
            <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
            <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
            <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
            <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
            <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
          </select>
        </div>

        <div class="col-md-4 mb-3">
          <label>Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ:</label>
          <select id="studioFilter" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="A">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ A</option>
            <option value="B">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ B</option>
          </select>
        </div>

        <div class="col-md-4 mb-3 d-grid">
          <label>&nbsp;</label>
          <button onclick="applyFilters()" class="btn btn-primary">ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙ„ØªØ±Ø©</button>
        </div>
      </div>
    </div>

    <div id="filteredResults"></div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAHf3U8lU8aoGv4YYUZ57iPvRHirSwNkew",
    projectId: "noon-a0b62"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
  const sessionTimes = [
    "08:00 - 10:00", "10:00 - 12:00", "12:00 - 14:00",
    "14:00 - 16:00", "16:00 - 18:00", "18:00 - 20:00", "20:00 - 22:00"
  ];

  let allSessions = [];

  async function loadData() {
    const snapshot = await db.collection("teachers").get();
    const teacherSelect = document.getElementById("teacherFilter");
    allSessions = [];
    const bookedSlots = {}; // Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª

    snapshot.docs.forEach(doc => {
      const t = doc.data();
      const durationWeeks = t.offer === "100" ? 24 : t.offer === "50" ? 6 : 3;
      const totalSessions = Math.floor(parseInt(t.offer) / 1.5);
      const startDate = new Date(t.startDate);
      let count = 0;

      const option = document.createElement("option");
      option.value = t.name;
      option.textContent = t.name;
      teacherSelect.appendChild(option);

      for (let w = 0; w < durationWeeks; w++) {
        for (let d = 0; d < 7; d++) {
          for (let time of sessionTimes) {
            const sessionDate = new Date(startDate);
            sessionDate.setDate(startDate.getDate() + (w * 7 + d));
            const dateStr = sessionDate.toISOString().split("T")[0];
            const jsDay = sessionDate.getDay();
            const dayName = days[jsDay];
            const slotKey = `${dateStr}_${time}`;
            const alreadyBooked = bookedSlots[slotKey] || [];

            if (t.availability[dayName]?.includes(time)) {
              if (count >= totalSessions) break;

              let studio = null;
              if (!alreadyBooked.includes("A")) {
                studio = "A";
                bookedSlots[slotKey] = [...alreadyBooked, "A"];
              } else if (!alreadyBooked.includes("B")) {
                studio = "B";
                bookedSlots[slotKey] = [...alreadyBooked, "B"];
              } else {
                continue;
              }

              allSessions.push({
                teacher: t.name,
                phone: t.phone,
                date: dateStr,
                day: dayName,
                time: time,
                studio
              });

              count++;
            }
          }
        }
      }
    });
  }

  function applyFilters() {
    const teacherVal = document.getElementById("teacherFilter").value;
    const startVal = document.getElementById("startDateFilter").value;
    const endVal = document.getElementById("endDateFilter").value;
    const dayVal = document.getElementById("dayFilter").value;
    const studioVal = document.getElementById("studioFilter").value;

    let filtered = allSessions;

    if (teacherVal) filtered = filtered.filter(s => s.teacher === teacherVal);
    if (startVal) filtered = filtered.filter(s => s.date >= startVal);
    if (endVal) filtered = filtered.filter(s => s.date <= endVal);
    if (dayVal) filtered = filtered.filter(s => s.day === dayVal);
    if (studioVal) filtered = filtered.filter(s => s.studio === studioVal);

    displayResults(filtered);
  }

  function displayResults(data) {
    const out = document.getElementById("filteredResults");
    if (data.length === 0) {
      out.innerHTML = `<div class="alert alert-warning">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
      return;
    }

    out.innerHTML = data.map(s => `
      <div class="session-card">
        ğŸ‘¨â€ğŸ« ${s.teacher} | ğŸ“… ${s.date} (${s.day})<br>
        â° ${s.time} | ğŸ¥ <span class="${s.studio === 'A' ? 'studio-a' : 'studio-b'}">${s.studio}</span>
      </div>
    `).join("");
  }

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  loadData();
</script>
</body>
</html>
