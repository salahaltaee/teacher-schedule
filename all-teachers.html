<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <style>
    body { direction: rtl; }
    .card-teacher { border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2 class="mb-4">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h2>

    <div class="row mb-4">
      <div class="col-md-6 mb-2">
        <input type="text" id="searchName" class="form-control" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°">
      </div>
      <div class="col-md-6 mb-2">
        <select id="filterOffer" class="form-select">
          <option value="">ğŸ“¦ ÙƒÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶</option>
          <option value="15">15 Ø³Ø§Ø¹Ø©</option>
          <option value="50">50 Ø³Ø§Ø¹Ø©</option>
          <option value="100">100 Ø³Ø§Ø¹Ø©</option>
        </select>
      </div>
    </div>

    <div id="teacherList" class="row"></div>
    <a href="index.html" class="btn btn-secondary mt-3">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHf3U8lU8aoGv4YYUZ57iPvRHirSwNkew",
      projectId: "noon-a0b62"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadTeachers() {
      const snapshot = await db.collection("teachers").get();
      const list = document.getElementById("teacherList");
      list.innerHTML = "";

      const searchName = document.getElementById("searchName").value.toLowerCase();
      const filterOffer = document.getElementById("filterOffer").value;
      const today = new Date();

      snapshot.docs.forEach(doc => {
        const t = doc.data();
        const id = doc.id;

        if (searchName && !t.name.toLowerCase().includes(searchName)) return;
        if (filterOffer && t.offer !== filterOffer) return;

        const originalHours = parseInt(t.offer);
        const completedSessions = ((originalHours - t.remainingHours) / 1.5).toFixed(0);
        const remainingSessions = (t.remainingHours / 1.5).toFixed(0);
        const startDate = new Date(t.startDate);
        const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));

        const card = document.createElement("div");
        card.className = "col-md-6";
        card.innerHTML = `
          <div class="card-teacher">
            <strong>${t.name}</strong> - ${t.offer} Ø³Ø§Ø¹Ø©<br>
            ğŸ“ ${t.phone} | ÙŠØ¨Ø¯Ø£: ${t.startDate}<br>
            ğŸ’° ${t.amountPaid} / ${t.totalAmount}<br>
            â±ï¸ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${t.remainingHours} Ø³Ø§Ø¹Ø©
            <div class="mt-2 text-muted small">
              ğŸ“ˆ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©: ${completedSessions} Ø¬Ù„Ø³Ø©<br>
              â³ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${remainingSessions} Ø¬Ù„Ø³Ø©<br>
              ğŸ—“ï¸ Ù…Ù†Ø° Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ${daysSinceStart} ÙŠÙˆÙ…Ù‹Ø§
            </div>
            <div class="mt-2 d-flex gap-2 flex-wrap">
              <a href="details.html?teacher=${encodeURIComponent(t.name)}" class="btn btn-sm btn-outline-primary">ğŸ“„ ØªÙØ§ØµÙŠÙ„</a>
              <button onclick="editTeacher('${id}')" class="btn btn-sm btn-warning">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button onclick="deleteTeacher('${id}')" class="btn btn-sm btn-danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              <button onclick="decreaseHours('${id}', ${t.remainingHours})" class="btn btn-sm btn-secondary">â– 1.5 Ø³Ø§Ø¹Ø©</button>
              <a href="https://wa.me/${t.phone}?text=${encodeURIComponent('Ù…Ø±Ø­Ø¨Ø§ Ø§Ø³ØªØ§Ø° ' + t.name + ' Ø§Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© Ù†ÙˆÙ†')}" target="_blank" class="btn btn-sm btn-success">ğŸ’¬ ØªØ±Ø­ÙŠØ¨ ÙˆØ§ØªØ³Ø§Ø¨</a>
            </div>
          </div>
        `;

        list.appendChild(card);
      });
    }

    function editTeacher(id) {
      window.location.href = `edit-teacher.html?id=${id}`;
    }

    async function deleteTeacher(id) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø°ØŸ")) {
        await db.collection("teachers").doc(id).delete();
        loadTeachers();
      }
    }

    async function decreaseHours(id, currentHours) {
      const updated = Math.max(0, currentHours - 1.5);
      await db.collection("teachers").doc(id).update({ remainingHours: updated });
      loadTeachers();
    }

    document.getElementById("searchName").addEventListener("input", loadTeachers);
    document.getElementById("filterOffer").addEventListener("change", loadTeachers);

    loadTeachers();
  </script>
</body>
</html>
