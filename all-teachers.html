<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>قائمة الأساتذة</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <style>
    body { direction: rtl; }
    .card-teacher { border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2 class="mb-4">📋 جميع الأساتذة</h2>

    <div class="row mb-4">
      <div class="col-md-6 mb-2">
        <input type="text" id="searchName" class="form-control" placeholder="🔍 بحث باسم الأستاذ">
      </div>
      <div class="col-md-6 mb-2">
        <select id="filterOffer" class="form-select">
          <option value="">📦 كل العروض</option>
          <option value="15">15 ساعة</option>
          <option value="50">50 ساعة</option>
          <option value="100">100 ساعة</option>
        </select>
      </div>
    </div>

    <div id="teacherList" class="row"></div>
    <a href="index.html" class="btn btn-secondary mt-3">🔙 رجوع للصفحة الرئيسية</a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHf3U8lU8aoGv4YYUZ57iPvRHirSwNkew",
      projectId: "noon-a0b62"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadTeachers() {
      const snapshot = await db.collection("teachers").get();
      const list = document.getElementById("teacherList");
      list.innerHTML = "";

      const searchName = document.getElementById("searchName").value.toLowerCase();
      const filterOffer = document.getElementById("filterOffer").value;
      const today = new Date();

      snapshot.docs.forEach(doc => {
        const t = doc.data();
        const id = doc.id;

        if (searchName && !t.name.toLowerCase().includes(searchName)) return;
        if (filterOffer && t.offer !== filterOffer) return;

        const originalHours = parseInt(t.offer);
        const completedSessions = ((originalHours - t.remainingHours) / 1.5).toFixed(0);
        const remainingSessions = (t.remainingHours / 1.5).toFixed(0);
        const startDate = new Date(t.startDate);
        const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));

        const card = document.createElement("div");
        card.className = "col-md-6";
        card.innerHTML = `
          <div class="card-teacher">
            <strong>${t.name}</strong> - ${t.offer} ساعة<br>
            📞 ${t.phone} | يبدأ: ${t.startDate}<br>
            💰 ${t.amountPaid} / ${t.totalAmount}<br>
            ⏱️ المتبقي: ${t.remainingHours} ساعة
            <div class="mt-2 text-muted small">
              📈 الجلسات المنجزة: ${completedSessions} جلسة<br>
              ⏳ الجلسات المتبقية: ${remainingSessions} جلسة<br>
              🗓️ منذ بدء الاشتراك: ${daysSinceStart} يومًا
            </div>
            <div class="mt-2 d-flex gap-2 flex-wrap">
              <a href="details.html?teacher=${encodeURIComponent(t.name)}" class="btn btn-sm btn-outline-primary">📄 تفاصيل</a>
              <button onclick="editTeacher('${id}')" class="btn btn-sm btn-warning">✏️ تعديل</button>
              <button onclick="deleteTeacher('${id}')" class="btn btn-sm btn-danger">🗑️ حذف</button>
              <button onclick="decreaseHours('${id}', ${t.remainingHours})" class="btn btn-sm btn-secondary">➖ 1.5 ساعة</button>
              <a href="https://wa.me/${t.phone}?text=${encodeURIComponent('مرحبا استاذ ' + t.name + ' اهلا وسهلا بك في عائلة نون')}" target="_blank" class="btn btn-sm btn-success">💬 ترحيب واتساب</a>
            </div>
          </div>
        `;

        list.appendChild(card);
      });
    }

    function editTeacher(id) {
      window.location.href = `edit-teacher.html?id=${id}`;
    }

    async function deleteTeacher(id) {
      if (confirm("هل أنت متأكد من حذف الأستاذ؟")) {
        await db.collection("teachers").doc(id).delete();
        loadTeachers();
      }
    }

    async function decreaseHours(id, currentHours) {
      const updated = Math.max(0, currentHours - 1.5);
      await db.collection("teachers").doc(id).update({ remainingHours: updated });
      loadTeachers();
    }

    document.getElementById("searchName").addEventListener("input", loadTeachers);
    document.getElementById("filterOffer").addEventListener("change", loadTeachers);

    loadTeachers();
  </script>
</body>
</html>
