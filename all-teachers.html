<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>كل الأساتذة</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <style>
    body { direction: rtl; }
    .teacher-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
    .status-green { color: green; font-weight: bold; }
    .status-yellow { color: orange; font-weight: bold; }
    .status-red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="mb-4">📚 قائمة كل الأساتذة</h1>
    <div id="teachersList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHf3U8lU8aoGv4YYUZ57iPvRHirSwNkew",
      projectId: "noon-a0b62"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function getStatusColor(remaining, total) {
      const remainingSessions = Math.floor(remaining / 1.5);
      if (remainingSessions === 0) return "🔴 منتهي";
      if (remainingSessions <= 3) return "🟡 على وشك الانتهاء";
      return "🟢 نشط";
    }

    function calculateDaysSince(dateStr) {
      const start = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      return diff;
    }

    db.collection("teachers").get().then(snapshot => {
      let html = "";
      snapshot.forEach(doc => {
        const t = doc.data();
        const status = getStatusColor(t.remainingHours, parseInt(t.offer));
        const done = Math.floor((parseInt(t.offer) - t.remainingHours) / 1.5);
        const left = Math.floor(t.remainingHours / 1.5);
        const daysSince = calculateDaysSince(t.startDate);
        html += `
          <div class="teacher-card">
            <h5>${t.name} - ${t.offer} ساعة</h5>
            <p>هاتف: ${t.phone} | بدأ: ${t.startDate}</p>
            <p>المدفوع: ${t.amountPaid} / ${t.totalAmount}</p>
            <p>💼 الحالة: ${status}</p>
            <p>📊 الجلسات المنجزة: ${done} | المتبقية: ${left} | منذ البدء: ${daysSince} يوم</p>
            <a href="details.html?id=${doc.id}" class="btn btn-primary btn-sm">📄 تفاصيل</a>
            <a href="edit-teacher.html?id=${doc.id}" class="btn btn-warning btn-sm">✏️ تعديل</a>
            <button onclick="deleteTeacher('${doc.id}')" class="btn btn-danger btn-sm">🗑️ حذف</button>
            <a href="https://wa.me/${t.phone}?text=مرحبا استاذ ${encodeURIComponent(t.name)} اهلا وسهلا بك في عائلة نون" target="_blank" class="btn btn-success btn-sm">📩 ترحيب</a>
            <button onclick="decreaseHour('${doc.id}', ${t.remainingHours})" class="btn btn-outline-danger btn-sm">➖ جلسة (1.5 ساعة)</button>
          </div>
        `;
      });
      document.getElementById("teachersList").innerHTML = html;
    });

    function deleteTeacher(id) {
      if (confirm("هل أنت متأكد من حذف الأستاذ؟")) {
        db.collection("teachers").doc(id).delete().then(() => location.reload());
      }
    }

    function decreaseHour(id, hours) {
      const newHours = Math.max(0, hours - 1.5);
      db.collection("teachers").doc(id).update({ remainingHours: newHours }).then(() => location.reload());
    }
  </script>
</body>
</html>
